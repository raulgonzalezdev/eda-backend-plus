input {
  kafka {
    bootstrap_servers => "${KAFKA_BOOTSTRAP:kafka:9092}"
    topics => ["alerts.suspect"]
    group_id => "logstash-alerts-enricher"
    codec => json
  }
}

filter {
  mutate {
    add_field => { "pipeline" => "alerts_enriched" }
  }
  if [payload][amount] {
    ruby {
      code => 'amt = event.get("[payload][amount]").to_f; event.set("risk_level", amt >= 10000 ? "high" : "normal")'
    }
  }
}

output {
  elasticsearch {
    hosts => ["${ELASTICSEARCH_HOST:http://elasticsearch:9200}"]
    index => "alerts.enriched-%{+YYYY.MM.dd}"
    user => "${ELASTIC_USER:elastic}"
    password => "${ELASTIC_PASSWORD:changeme}"
  }
}