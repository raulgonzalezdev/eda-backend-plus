input {
  kafka {
    bootstrap_servers => "${KAFKA_BOOTSTRAP:kafka:9092}"
    topics => ["alerts.suspect"]
    group_id => "logstash-alerts-enricher"
    codec => json
  }
}

filter {
  mutate {
    add_field => { "pipeline" => "alerts_enriched" }
  }
  ruby {
    code => '
      amt = event.get("[payload][amount]")
      amt = amt.nil? ? event.get("amount") : amt
      if !amt.nil?
        val = amt.to_f
        event.set("risk_level", val >= 10000 ? "high" : "normal")
      end
    '
  }
}

output {
  elasticsearch {
    hosts => ["${ELASTICSEARCH_HOST:http://elasticsearch:9200}"]
    index => "alerts.enriched-%{+YYYY.MM.dd}"
    user => "${ELASTIC_USER:elastic}"
    password => "${ELASTIC_PASSWORD:changeme}"
  }
}