# Dockerfile para Patroni con PostgreSQL 15
FROM postgres:15

# Instalar dependencias necesarias
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-dev \
    python3-psycopg2 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Instalar Patroni
RUN pip3 install patroni[etcd3]==3.1.0 --break-system-packages

# Crear directorios necesarios
RUN mkdir -p /etc/patroni /var/log/postgresql && \
    chown -R postgres:postgres /etc/patroni /var/log/postgresql

# Copiar configuraci贸n de Patroni
COPY patroni-config/patroni.yml /etc/patroni/patroni.yml
RUN chown postgres:postgres /etc/patroni/patroni.yml

# Crear directorio para scripts de inicializaci贸n
RUN mkdir -p /docker-entrypoint-initdb.d && \
    chown postgres:postgres /docker-entrypoint-initdb.d

# Copiar scripts de inicializaci贸n
COPY scripts/init-patroni-database.sh /docker-entrypoint-initdb.d/init-patroni-database.sh
COPY sql/create_pos_schema_and_tables.sql /docker-entrypoint-initdb.d/create_pos_schema_and_tables.sql
RUN chmod +x /docker-entrypoint-initdb.d/init-patroni-database.sh && \
    chown postgres:postgres /docker-entrypoint-initdb.d/init-patroni-database.sh && \
    chown postgres:postgres /docker-entrypoint-initdb.d/create_pos_schema_and_tables.sql

# Script de inicializaci贸n para configurar permisos
RUN echo '#!/bin/bash\n\
if [ ! -d "/var/lib/postgresql/data/base" ]; then\n\
    mkdir -p /var/lib/postgresql/data\n\
    chown postgres:postgres /var/lib/postgresql/data\n\
    chmod 700 /var/lib/postgresql/data\n\
fi\n\
exec patroni /etc/patroni/patroni.yml' > /usr/local/bin/start-patroni.sh && \
    chmod +x /usr/local/bin/start-patroni.sh && \
    chown postgres:postgres /usr/local/bin/start-patroni.sh

# Cambiar al usuario postgres
USER postgres

# Exponer puertos
EXPOSE 5432 8008

# Comando por defecto
CMD ["/usr/local/bin/start-patroni.sh"]